#!/bin/bash

read -r -d '' TEMPLATE_PRE_COMMIT_HOOK << 'EOF'
#!/bin/bash

GIT_WORKTREE_DIR=\$(git rev-parse --show-toplevel)
GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

echo "GIT_BRANCH: $GIT_BRANCH"

# 部分一致での判定
# GIT_BRANCHにreleaseが含まれている場合は、コミットさせない
if [[ $GIT_BRANCH == *"release"* ]]; then
  echo "WARNING: release branch is not allowed to commit"
  exit 1
fi

# 完全一致での判定
case $GIT_BRANCH in
  "main" )
    echo "Error: main branch is not allowed to commit"
    exit 1
  ;;
  "HEAD" )
    echo "Warning: Probably rebase or merge is in progress. Skipping tests."
    exit 0
  ;;
  * )
    echo "Warning: No tests or configurations are registered for this branch"
    exit 1
  ;;
esac
EOF

# ヘルプメッセージを表示
show_help() {
    echo "Usage: pre-commit [COMMAND]"
    echo ""
    echo "Commands:"
    echo "  run     Execute the pre-commit hook"
    echo "  rm      Remove the pre-commit hook"
    echo "  edit    Edit the pre-commit hook (default behavior)"
    echo "  help    Show this help message"
    echo ""
    echo "If no command is specified, the default behavior is to edit the pre-commit hook."
}

# Gitリポジトリのワークツリーディレクトリを取得
GIT_WORKTREE_DIR=$(git rev-parse --show-toplevel 2>/dev/null)

if [ "$GIT_WORKTREE_DIR" == "" ]; then
    echo "Error: Current directory is not in a Git worktree."
    exit 1
fi

# .gitディレクトリ
GIT_COMMON_DIR=$(git rev-parse --git-common-dir 2>/dev/null)

PRE_COMMIT_PATH="$GIT_COMMON_DIR/hooks/pre-commit"

# サブコマンドを処理
case "${1:-edit}" in
    "run")
        if [ ! -f "$PRE_COMMIT_PATH" ]; then
            echo "Error: Pre-commit hook not found at $PRE_COMMIT_PATH"
            echo "Run 'pre-commit edit' first to create the hook."
            exit 1
        fi

        echo "Running pre-commit hook..."
        "$PRE_COMMIT_PATH"
        exit $?
        ;;

    "rm")
        if [ ! -f "$PRE_COMMIT_PATH" ]; then
            echo "Pre-commit hook not found at $PRE_COMMIT_PATH"
            echo "Nothing to remove."
            exit 0
        fi

        echo "Removing pre-commit hook..."
        rm "$PRE_COMMIT_PATH"
        echo "Pre-commit hook removed successfully."
        exit 0
        ;;

    "edit")
        if [ ! -f "$PRE_COMMIT_PATH" ]; then
            echo "Creating new pre-commit hook..."
            echo "$TEMPLATE_PRE_COMMIT_HOOK" > "$PRE_COMMIT_PATH"
            chmod +x "$PRE_COMMIT_PATH"
        fi

        cursor "$PRE_COMMIT_PATH"
        exit 0
        ;;

    "help"|"-h"|"--help")
        show_help
        exit 0
        ;;

    *)
        echo "Error: Unknown command '$1'"
        echo ""
        show_help
        exit 1
        ;;
esac
